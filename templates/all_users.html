{% extends "base.html" %} {% block content %} {% with messages = get_flashed_messages(with_categories=true) %} {% if messages %} {% for category, message in messages %} <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
  {{ message }}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div> {% endfor %} {% endif %} {% endwith %} <style>
  body.light-mode {
    --bg-card: #ffffff;
    --text-main: #000000;
    --border-color: #dee2e6;
    --muted: gray;
  }

  body.dark-mode {
    --bg-card: #1e1e1e;
    --text-main: #f8f9fa;
    --border-color: #444;
    --muted: #ccc;
  }

  .user-card {
    background-color: var(--bg-card) !important;
    color: var(--text-main) !important;
    border-color: var(--border-color) !important;
  }

  .text-muted {
    color: var(--muted) !important;
  }

  /* Role coloring */
  .role-select {
    color: white;
    font-weight: 600;
    border: none;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    width: auto;
  }

  .role-select[data-role="admin"] {
    background-color: #dc3545;
  }

  .role-select[data-role="support"] {
    background-color: #198754;
  }

  .role-select[data-role="blacklisted"] {
    background-color: #000000;
  }

  .role-select[data-role="user"] {
    background-color: #6c757d;
  }
</style>
<div class="container mt-4">
  <h2 class="text-body">All Users</h2>
  <form class="mb-4" method="get" action="{{ url_for('all_users') }}">
    <div class="row g-2">
      <div class="col-md-3">
        <select name="search_by" class="form-select">
          <option value="username" {% if search_by == 'username' %}selected{% endif %}>Username</option>
          <option value="email" {% if search_by == 'email' %}selected{% endif %}>Email</option>
          <option value="id" {% if search_by == 'id' %}selected{% endif %}>User ID</option>
        </select>
      </div>
      <div class="col-md-6">
        <input type="text" class="form-control" name="search" placeholder="Search" value="{{ search }}">
      </div>
      <div class="col-md-3">
        <button class="btn btn-primary w-100" type="submit">Search</button>
      </div>
    </div>
  </form> {% for user in users %} <div class="user-card p-3 mb-4 border rounded">
    <div class="d-flex align-items-center">
      <img src="{{ url_for('user_pfp', user_id=user.id) }}" class="me-3 rounded-circle border" style="width:60px; height:60px; object-fit:cover;" alt="pfp">
      <div>
        <h5 class="mb-0">{{ user.username }}
          <small class="text-muted">(ID: {{ user.id }})</small>
        </h5>
        <p class="mb-1">Email: {{ user.email }}</p>
        <form method="POST" action="{{ url_for('all_users') }}" class="d-flex align-items-center gap-2 mb-0" style="flex-wrap: wrap; max-width: 350px;">
          <label for="role-select-{{ user.id }}" class="mb-0" style="min-width: 50px;">Role:</label>
          <select name="new_role" id="role-select-{{ user.id }}" class="role-select form-select-sm" onchange="this.form.submit()" data-role="{{ user.role or 'user' }}">
            <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin</option>
            <option value="support" {% if user.role == 'support' %}selected{% endif %}>Support</option>
            <option value="blacklisted" {% if user.role == 'blacklisted' %}selected{% endif %}>Blacklisted</option>
            <option value="user" {% if user.role not in ['admin', 'support', 'blacklisted'] %}selected{% endif %}>User</option>
          </select>
          <input type="hidden" name="change_role_user_id" value="{{ user.id }}">
        </form>
        <p class="mb-0 mt-2"> Premium: <span class="badge {{ 'bg-success' if user.premium else 'bg-danger' }}">
            {{ 'Yes' if user.premium else 'No' }}
          </span> | Timezone: {{ user.timezone or 'Not set' }}
        </p>
      </div>
    </div>
    <div class="mt-3">
      <h6>Tickets:</h6> {% if user.tickets %} <div class="d-flex flex-wrap gap-2"> {% for ticket in user.tickets %} <a href="{{ url_for('view_ticket', ticket_id=ticket.id) }}" class="btn btn-outline-primary btn-sm">
          {{ ticket.title }} ({{ ticket.timestamp.strftime('%Y-%m-%d') }}) </a> {% endfor %} </div> {% else %} <p class="text-muted">No tickets.</p> {% endif %}
    </div>
    <div class="mt-3">
      <h6>Suggestions:</h6> {% if user.suggestions %} <ul> {% for suggestion in user.suggestions %} <li>
          <strong>{{ suggestion.title }}</strong>
          <small class="text-muted">(ID: {{ suggestion.id }})</small> — {{ suggestion.timestamp.strftime('%Y-%m-%d %H:%M') }}
        </li> {% endfor %} </ul> {% else %} <p class="text-muted">No suggestions.</p> {% endif %}
    </div>
    <form method="POST" action="{{ url_for('all_users') }}" class="mt-3" onsubmit="return confirm('Are you sure you want to delete this user?');">
      <input type="hidden" name="delete_user_id" value="{{ user.id }}">
      <button type="submit" class="btn btn-danger btn-sm">Delete Account</button>
    </form>
  </div> {% endfor %} <nav aria-label="User pagination">
    <ul class="pagination justify-content-center"> {% if pagination.has_prev %} <li class="page-item">
        <a class="page-link" href="{{ url_for('all_users', page=pagination.prev_num, search=search, search_by=request.args.get('search_by')) }}">&laquo; Prev</a>
      </li> {% else %} <li class="page-item disabled">
        <span class="page-link">&laquo; Prev</span>
      </li> {% endif %} {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %} {% if page_num %} {% if page_num == pagination.page %} <li class="page-item active">
        <span class="page-link">{{ page_num }}</span>
      </li> {% else %} <li class="page-item">
        <a class="page-link" href="{{ url_for('all_users', page=page_num, search=search, search_by=request.args.get('search_by')) }}">{{ page_num }}</a>
      </li> {% endif %} {% else %} <li class="page-item disabled">
        <span class="page-link">…</span>
      </li> {% endif %} {% endfor %} {% if pagination.has_next %} <li class="page-item">
        <a class="page-link" href="{{ url_for('all_users', page=pagination.next_num, search=search, search_by=request.args.get('search_by')) }}">Next &raquo;</a>
      </li> {% else %} <li class="page-item disabled">
        <span class="page-link">Next &raquo;</span>
      </li> {% endif %} </ul>
  </nav>
</div> {% endblock %}